buildscript {
  ext.getExtOrDefault = {name ->
    return rootProject.ext.has(name) ? rootProject.ext.get(name) : project.properties['BuildersWallet_' + name]
  }

  repositories {
    google()
    mavenCentral()
  }

  dependencies {
    classpath "com.android.tools.build:gradle:8.7.2"
    // noinspection DifferentKotlinGradleVersion
    classpath "org.jetbrains.kotlin:kotlin-gradle-plugin:${getExtOrDefault('kotlinVersion')}"
  }
}


apply plugin: "com.android.library"
apply plugin: "kotlin-android"

apply plugin: "com.facebook.react"

def getExtOrIntegerDefault(name) {
  return rootProject.ext.has(name) ? rootProject.ext.get(name) : (project.properties["BuildersWallet_" + name]).toInteger()
}

android {
  namespace "com.builders.wallet"

  compileSdkVersion getExtOrIntegerDefault("compileSdkVersion")

  buildFeatures {
    buildConfig true
  }

  defaultConfig {
    minSdkVersion getExtOrIntegerDefault("minSdkVersion")
    targetSdkVersion getExtOrIntegerDefault("targetSdkVersion")
    
    // Configuração para Google Wallet Mock
    // Define se deve usar implementação mock baseado em variável de ambiente
    buildConfigField "boolean", "GOOGLE_WALLET_USE_MOCK", 
      project.hasProperty('GOOGLE_WALLET_USE_MOCK') ? 
        project.property('GOOGLE_WALLET_USE_MOCK') : 
        "false"
    
    // Configuração da URL da API Mock
    buildConfigField "String", "GOOGLE_WALLET_MOCK_API_URL", 
      project.hasProperty('GOOGLE_WALLET_MOCK_API_URL') ? 
        "\"${project.property('GOOGLE_WALLET_MOCK_API_URL')}\"" : 
        "\"\""
  }
  

  buildTypes {
    release {
      minifyEnabled false
    }
  }

  lintOptions {
    disable "GradleCompatible"
  }

  compileOptions {
    sourceCompatibility JavaVersion.VERSION_1_8
    targetCompatibility JavaVersion.VERSION_1_8
  }

  sourceSets {
    main {
      java.srcDirs += [
        "generated/java",
        "generated/jni"
      ]
    }
  }
}

repositories {
  mavenCentral()
  google()
}

def kotlin_version = getExtOrDefault("kotlinVersion")

dependencies {
  implementation "com.facebook.react:react-android"
  implementation "org.jetbrains.kotlin:kotlin-stdlib:$kotlin_version"
}

// Adiciona Google Play Services Tap and Pay condicionalmente
// Só adiciona se a propriedade estiver definida como true
if (project.hasProperty('includeGooglePay') && 
    project.property('includeGooglePay') == 'true') {
  dependencies {
    implementation 'com.google.android.gms:play-services-tapandpay:+'
  }
  println "✅ Google Play Services Tap and Pay incluído"
} else {
  println "⚠️ Google Play Services Tap and Pay não incluído (defina includeGooglePay=true para incluir)"
}

// Adiciona Samsung Pay SDK condicionalmente
// Só adiciona se a propriedade estiver definida como true
if (project.hasProperty('enableSamsungPay') && 
    project.property('enableSamsungPay') == 'true') {
  
  // Tenta encontrar o JAR na pasta libs do projeto
  def libsPath = "${rootProject.projectDir}/libs"
  def libsDir = new File(libsPath)
  
  def samsungPayJar = null
  def samsungPayVersion = "desconhecida"
  
  if (libsDir.exists() && libsDir.isDirectory()) {
    // Procura por arquivos que comecem com "samsungpay_" e terminem com ".jar"
    def jarFiles = libsDir.listFiles(new FilenameFilter() {
      boolean accept(File dir, String name) {
        return name.startsWith("samsungpay_") && name.endsWith(".jar")
      }
    })
    
    if (jarFiles && jarFiles.length > 0) {
      samsungPayJar = jarFiles[0]
      // Extrai a versão do nome do arquivo
      def fileName = samsungPayJar.getName()
      def versionMatch = fileName =~ /samsungpay_(.+)\.jar/
      if (versionMatch) {
        samsungPayVersion = versionMatch[0][1]
      }
      println "✅ Samsung Pay SDK encontrado: ${samsungPayJar.getName()}"
      println "✅ Versão detectada: ${samsungPayVersion}"
    } else {
      println "⚠️ Nenhum arquivo samsungpay_*.jar encontrado em: ${libsPath}"
      println "⚠️ Certifique-se de que existe um arquivo que comece com 'samsungpay_' e termine com '.jar'"
    }
  } else {
    println "⚠️ Pasta libs não encontrada: ${libsPath}"
    println "⚠️ Certifique-se de que a pasta android/libs existe no seu projeto"
  }
  
  if (samsungPayJar) {
    dependencies {
      implementation files(samsungPayJar)
    }
    println "✅ Samsung Pay SDK v${samsungPayVersion} incluído de: ${samsungPayJar.getAbsolutePath()}"
  }
} else {
  println "⚠️ Samsung Pay SDK não incluído (defina enableSamsungPay=true para incluir)"
}
